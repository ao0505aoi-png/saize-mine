<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1000円ガチャ（個人用）</title>
<style>
  body { font-family: sans-serif; background: #ffffff; padding: 20px; }
  .btn { padding: 10px 18px; background: #4CAF50; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
  .btn:disabled { background: #aaa; }
  #result { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; }
</style>
</head>

<body>

<h2>1000円ガチャ（個人用）</h2>

<p>※データは固定のスプレッドシート（CSV）から読み込みます。</p>

<button id="loadBtn" class="btn">データを読み込む</button>
<button id="gachaBtn" class="btn" disabled>ガチャを回す</button>

<div id="result">データ未読込み</div>


<script>
// -----------------------------
// ★ 固定するスプレッドシート URL
// -----------------------------
const FIXED_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKqsI81JSubHb3Sdh-9HVDe-cV9yHzlsfLt1fw8oH-zb-cVC1Dv8dcBsZLlQRc4KHtyHtqSmeJ8gjV/pub?output=csv";

let items = []; // 商品データ格納

// CSVを読み込んでitemsに格納
function loadCSV() {
    fetch(FIXED_CSV_URL)
    .then(res => res.text())
    .then(text => {
        const lines = text.trim().split("\n");
        
        // ★デバッグ：ヘッダーと最初のデータ行を確認
        console.log("ヘッダー:", lines[0]);
        console.log("1行目データ:", lines[1]);
        
        items = lines.slice(1).map(line => {
            const cols = line.split(",");
            
            // ★デバッグ：分割結果を確認
            console.log("分割結果:", cols);
            
            const [id, product_no, name, price, category] = cols;
            
            const item = { 
                id: id?.trim() || "",
                product_no: product_no?.trim() || "",
                name: name?.trim() || "", 
                price: Number(price?.trim()) || 0, 
                category: category?.trim() || ""
            };
            
            // ★デバッグ：作成されたアイテム
            console.log("アイテム:", item);
            
            return item;
        });

        console.log("全アイテム:", items);
        document.getElementById("result").innerHTML = `データ読み込み完了！(${items.length}件)`;
        document.getElementById("gachaBtn").disabled = false;
    })
    .catch(err => {
        document.getElementById("result").innerHTML = "読み込みエラー：URLを確認してください";
        console.error(err);
    });
}


// -----------------------------
// ★ ちょうど1000円になる組み合わせを計算
// -----------------------------
function findExact1000Combination() {
    const target = 1000;
    const n = items.length;
    let results = [];

    // 全ての組み合わせを探索（ビット全探索）
    for (let mask = 1; mask < (1 << n); mask++) {
        let sum = 0;
        let combo = [];

        for (let i = 0; i < n; i++) {
            if (mask & (1 << i)) {
                sum += items[i].price;
                combo.push(items[i]);
            }
        }

        if (sum === target) {
            results.push(combo);
        }
    }

    // 組み合わせがない場合
    if (results.length === 0) return null;

    // ランダムに1つ返す
    return results[Math.floor(Math.random() * results.length)];
}


// -----------------------------
// ガチャ実行
// -----------------------------
function runGacha() {
    const combo = findExact1000Combination();

    if (!combo) {
        document.getElementById("result").innerHTML = 
            "1000円ぴったりになる組み合わせが見つかりませんでした。<br>（メニューを見直してください）";
        return;
    }

    let html = "<h3>ガチャ結果（1000円ぴったり）</h3><ul>";

    combo.forEach(item => {
        // ★デバッグ出力
        console.log("表示アイテム:", item);
        html += `<li>${item.product_no} ${item.name} ${item.price}円</li>`;
    });

    html += "</ul>";

    document.getElementById("result").innerHTML = html;
}


// ボタンのイベント
document.getElementById("loadBtn").onclick = loadCSV;
document.getElementById("gachaBtn").onclick = runGacha;

</script>

</body>
</html>